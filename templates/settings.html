<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - AGI-119</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --accent-color: #667eea;
            --primary-bg: #f8f9fa;
            --text-color: #333;
            --border-color: #dee2e6;
            --scrollbar-bg: rgba(0, 0, 0, 0.05);
            --scrollbar-thumb: rgba(0, 0, 0, 0.2);
        }

        body.dark-mode {
            --primary-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --scrollbar-bg: rgba(255, 255, 255, 0.05);
            --scrollbar-thumb: rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
        }

        .card {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: #667eea;
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 15px;
            font-weight: bold;
        }

        body.dark-mode .card {
            background: #2d2d2d;
            border-color: #404040;
        }

        .btn-back {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .btn-back:hover {
            background: #5568d3;
            color: white;
        }

        .form-control, .form-select, textarea {
            background: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        body.dark-mode .form-control,
        body.dark-mode .form-select,
        body.dark-mode textarea {
            background: #3d3d3d;
            border-color: #555;
            color: #e0e0e0;
        }

        .form-control:focus,
        .form-select:focus,
        textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: #667eea;
            border: none;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .alert {
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .settings-group {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-group:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .stat-box {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            margin: 10px 0;
        }

        body.dark-mode .stat-box {
            background: #5568d3;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .history-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            background: #f0f2f5;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 12px;
        }

        body.dark-mode .history-item {
            background: #3d3d3d;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            .card {
                margin-bottom: 15px;
            }

            .chart-container {
                height: 250px;
            }

            .stat-box {
                padding: 15px;
            }
        }

        .success-msg {
            color: #28a745;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-msg {
            color: #dc3545;
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="btn-back">‚Üê Back to Chat</a>

        <!-- PROFILE SECTION -->
        <div class="card">
            <div class="card-header">üë§ Profile</div>
            <div class="card-body">
                <div class="settings-group">
                    <label class="settings-label">Username</label>
                    <input type="text" class="form-control" id="username" placeholder="Your name" />
                </div>
                <div class="settings-group">
                    <label class="settings-label">Email</label>
                    <input type="email" class="form-control" id="useremail" placeholder="Your email" readonly />
                </div>
            </div>
        </div>

        <!-- GEMINI API KEY SECTION -->
        <div class="card">
            <div class="card-header">üîë Gemini API Configuration</div>
            <div class="card-body">
                <div class="settings-group">
                    <label class="settings-label">Gemini API Key</label>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Your API key is stored securely and used for generating intelligent responses.</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" class="form-control" id="geminiKey" placeholder="Paste your Gemini API key here" />
                        <button class="btn btn-primary" onclick="updateGeminiKey()" style="min-width: 100px;">Update</button>
                    </div>
                    <div class="success-msg" id="geminiSuccess">‚úì Gemini API key updated successfully</div>
                    <div class="error-msg" id="geminiError"></div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">API Usage & Quota</label>
                    <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Daily Requests</span>
                            <span style="font-weight: bold;"><span id="usageCount">0</span> / <span id="quotaLimit">100</span></span>
                        </div>
                        <div class="progress" style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                            <div id="usageBar" class="progress-bar" role="progressbar" style="width: 0%; background: var(--accent-color);"></div>
                        </div>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; margin-bottom: 0;">
                            Usage resets daily. Quota is estimated based on typical free tier limits.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- THEME SETTINGS -->
        <div class="card">
            <div class="card-header">üé® Theme Settings</div>
            <div class="card-body">
                <div class="settings-group">
                    <label class="settings-label">Dark Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-group">
                    <label class="settings-label">Theme Color</label>
                    <input type="color" class="form-control" id="themeColor" value="#667eea" onchange="saveTheme()" style="height: 40px;" />
                </div>
            </div>
        </div>

        <!-- PREFERENCES -->
        <div class="card">
            <div class="card-header">‚öôÔ∏è Preferences</div>
            <div class="card-body">
                <div class="settings-group">
                    <label class="settings-label">Therapeutic Style</label>
                    <select class="form-select" id="therapeuticStyle" onchange="savePreferences()">
                        <option value="empathetic">Empathetic</option>
                        <option value="practical">Practical</option>
                        <option value="analytical">Analytical</option>
                        <option value="supportive">Supportive</option>
                    </select>
                </div>
                <div class="settings-group">
                    <label class="settings-label">Max Response Tokens</label>
                    <input type="number" class="form-control" id="maxTokens" min="100" max="4000" value="1000" onchange="savePreferences()" />
                </div>
                <div class="settings-group">
                    <label class="settings-label">
                        <label class="toggle-switch">
                            <input type="checkbox" id="audioEnabled" onchange="savePreferences()">
                            <span class="slider"></span>
                        </label>
                        Enable Audio Input
                    </label>
                </div>
            </div>
        </div>

        <!-- ANALYTICS DASHBOARD -->
        <div class="card">
            <div class="card-header">üìä Chat Analytics</div>
            <div class="card-body" id="analyticsSection">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div class="stat-box">
                        <div class="stat-number" id="totalMessages">0</div>
                        <div class="stat-label">Total Messages</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="userMessages">0</div>
                        <div class="stat-label">Your Messages</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="aiMessages">0</div>
                        <div class="stat-label">AI Responses</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="avgDaily">0</div>
                        <div class="stat-label">Avg Daily</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="conditionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- CHAT HISTORY -->
        <div class="card">
            <div class="card-header">üìú Recent Messages (Last 20)</div>
            <div class="card-body" id="historySection">
                <!-- History will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let conditionsChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadAnalytics();
            loadHistory();
            checkTheme();
        });

        function loadSettings() {
            fetch('/api/settings', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.settings) {
                        const s = data.settings;
                        document.getElementById('darkModeToggle').checked = s.dark_mode || false;
                        document.getElementById('themeColor').value = s.theme_color || '#667eea';
                        document.getElementById('therapeuticStyle').value = s.therapeutic_style || 'empathetic';
                        document.getElementById('maxTokens').value = s.max_tokens || 1000;
                        document.getElementById('audioEnabled').checked = s.enable_audio || true;
                        
                        // Usage Stats
                        const usage = s.usage_count || 0;
                        const quota = s.quota_limit || 100;
                        document.getElementById('usageCount').textContent = usage;
                        document.getElementById('quotaLimit').textContent = quota;
                        
                        const pct = Math.min(100, (usage / quota) * 100);
                        const bar = document.getElementById('usageBar');
                        bar.style.width = pct + '%';
                        
                        if (pct > 90) bar.style.backgroundColor = '#dc3545';
                        else if (pct > 70) bar.style.backgroundColor = '#ffc107';
                        else bar.style.backgroundColor = '#28a745';
                    }
                })
                .catch(err => console.error('Error loading settings:', err));
        }

        function loadAnalytics() {
            fetch('/api/analytics/chat-stats?days=30', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalMessages').textContent = data.total_messages;
                        document.getElementById('userMessages').textContent = data.user_messages;
                        document.getElementById('aiMessages').textContent = data.ai_messages;
                        document.getElementById('avgDaily').textContent = data.avg_daily?.toFixed(1) || '0';
                    }
                })
                .catch(err => console.error('Error loading analytics:', err));

            fetch('/api/analytics/health?days=30', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.conditions) {
                        drawConditionsChart(data.conditions);
                    }
                })
                .catch(err => console.error('Error loading health analytics:', err));
        }

        function drawConditionsChart(conditions) {
            const ctx = document.getElementById('conditionsChart').getContext('2d');
            
            if (conditionsChart) {
                conditionsChart.destroy();
            }

            const labels = conditions.map(c => c._id || 'Unknown');
            const data = conditions.map(c => c.count);
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];

            conditionsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels === [] ?  ['No data yet'] : labels,
                    datasets: [{
                        data: data.length === 0 ? [1] : data,
                        backgroundColor: colors.slice(0, Math.max(labels.length, 1)),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function loadHistory() {
            fetch('/api/user-history?limit=20', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.history) {
                        const historyDiv = document.getElementById('historySection');
                        historyDiv.innerHTML = '';
                        
                        if (data.history.length === 0) {
                            historyDiv.innerHTML = '<p style="text-align: center; color: #999;">No chat history yet</p>';
                            return;
                        }

                        data.history.forEach(msg => {
                            const item = document.createElement('div');
                            item.className = 'history-item';
                            item.innerHTML = `
                                <strong>${msg.text.substring(0, 5)}...</strong>: ${msg.text.substring(0, 60)}...
                                <br><small style="opacity: 0.7;">${new Date(msg.timestamp).toLocaleString()}</small>
                            `;
                            historyDiv.appendChild(item);
                        });
                    }
                })
                .catch(err => console.error('Error loading history:', err));
        }

        function updateGeminiKey() {
            const key = document.getElementById('geminiKey').value.trim();
            const successMsg = document.getElementById('geminiSuccess');
            const errorMsg = document.getElementById('geminiError');
            
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            if (!key) {
                errorMsg.textContent = '‚ùå Please enter an API key';
                errorMsg.style.display = 'block';
                return;
            }

            fetch('/api/settings/gemini-key', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ api_key: key })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    successMsg.style.display = 'block';
                    document.getElementById('geminiKey').value = '';
                    setTimeout(() => successMsg.style.display = 'none', 3000);
                } else {
                    errorMsg.textContent = '‚ùå ' + (data.message || 'Error saving key');
                    errorMsg.style.display = 'block';
                }
            })
            .catch(err => {
                errorMsg.textContent = '‚ùå Error: ' + err.message;
                errorMsg.style.display = 'block';
            });
        }

        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.body.classList.toggle('dark-mode', isDark);
            saveTheme();
        }

        function saveTheme() {
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            const darkMode = document.getElementById('darkModeToggle').checked;
            const themeColor = document.getElementById('themeColor').value;

            fetch('/api/settings/theme', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    theme: theme,
                    dark_mode: darkMode,
                    theme_color: themeColor
                })
            })
            .catch(err => console.error('Error saving theme:', err));
        }

        function savePreferences() {
            // Could add endpoint to save preferences
            console.log('Preferences updated');
        }

        function checkTheme() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        }
    </script>
</body>
</html>
